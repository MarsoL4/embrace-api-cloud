# Rode após clonar o repositório

# Entra na pasta do projeto
cd embrace-api-cloud

# Cria grupo de recursos Azure
az group create --name embrace-rg --location brazilSouth

# Cria servidor SQL
az sql server create --name embracesqlserver --resource-group embrace-rg --location brazilSouth --admin-user embraceadmin --admin-password "Embrace#2025"

# Cria banco de dados SQL
az sql db create --resource-group embrace-rg --server embracesqlserver --name embrace-db --service-objective S0

# Mostra string de conexão do banco
az sql db show-connection-string --server embracesqlserver --name embrace-db --client ado.net
# Obs: Na String recebida, será necessário adicionar o Usuário (User ID) e Senha (Password) do Banco de Dados nos espaços indicados para que funcione normalmente.

# Libera acesso do App Service ao SQL
az sql server firewall-rule create --resource-group embrace-rg --server embracesqlserver --name AllowAzureServices --start-ip-address 0.0.0.0 --end-ip-address 0.0.0.0

# Libera acesso do seu IP ao SQL
az sql server firewall-rule create --resource-group embrace-rg --server embracesqlserver --name AllowLocal --start-ip-address <SEU_IP> --end-ip-address <SEU_IP>

# Cria plano do App Service
az appservice plan create --name embrace-plan --resource-group embrace-rg --location brazilSouth --sku B1

# Cria App Service (.NET 8)
az webapp create --resource-group embrace-rg --plan embrace-plan --name embrace-app --runtime "dotnet:8"

# Cria recurso do Application Insights
az monitor app-insights component create --app embrace-insights --location brazilSouth --resource-group embrace-rg --application-type web

# Vincula o Application Insights ao App Service
az webapp config appsettings set --resource-group embrace-rg --name embrace-app --settings "APPINSIGHTS_INSTRUMENTATIONKEY=$(az monitor app-insights component show --app embrace-insights --resource-group embrace-rg --query 'instrumentationKey' -o tsv)"

# Configura string de conexão no App Service (adicione a String de Conexão exibida no comando acima atualizada com o Usuário e Senha do Banco)
az webapp config connection-string set --resource-group embrace-rg --name embrace-app --connection-string-type SQLAzure --settings SqlServer="<String_Recebida>"

# Publica projeto para pasta de deploy
dotnet publish -c Release -o ./publish

# Compacta arquivos publicados
Compress-Archive -Path ./publish/* -DestinationPath ./app.zip

# Faz deploy do zip para o App Service
az webapp deployment source config-zip --resource-group embrace-rg --name embrace-app --src ./app.zip
